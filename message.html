<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global P2P Applet</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #121212; color: #e0e0e0; margin: 0; display: flex; flex-direction: column; height: 100vh; 
        }
        
        /* Header Section */
        header { background: #1f1f1f; padding: 20px; border-bottom: 1px solid #333; text-align: center; }
        .status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background-color: #4caf50; }
        
        /* Device Info */
        .info-panel { background: #252525; padding: 10px; font-size: 0.85em; text-align: center; }
        .ip-box { color: #00a2ff; font-family: monospace; font-weight: bold; font-size: 1.1em; }

        /* Messaging Area */
        #display { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 10px 14px; border-radius: 12px; max-width: 80%; word-wrap: break-word; }
        .in { background: #333; align-self: flex-start; }
        .out { background: #0078d4; color: white; align-self: flex-end; }

        /* Input Controls */
        .input-area { background: #1f1f1f; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .row { display: flex; gap: 10px; }
        input { 
            flex: 1; padding: 12px; border-radius: 6px; border: 1px solid #444; 
            background: #2c2c2c; color: white; outline: none; 
        }
        button { 
            padding: 10px 18px; border-radius: 6px; border: none; 
            background: #0078d4; color: white; font-weight: bold; cursor: pointer; 
        }
        button:hover { background: #005a9e; }
    </style>
</head>
<body>

<header>
    <span id="dot" class="status-dot"></span> <strong>Global Messenger</strong>
</header>

<div class="info-panel">
    YOUR DEVICE ID: <span id="my-id" class="ip-box">WAITING...</span>
</div>

<div id="display">
    <div class="msg in">Welcome. Enter a Peer ID below to connect across the net.</div>
</div>

<div class="input-area">
    <div class="row">
        <input type="text" id="targetId" placeholder="Enter Receiver's ID">
        <button onclick="connectToPeer()">CONNECT</button>
    </div>
    <div class="row">
        <input type="text" id="message" placeholder="Type message...">
        <button onclick="sendMsg()">SEND</button>
    </div>
</div>

<script>
    /** --- INBUILT SCRIPT LOGIC --- **/
    
    // 1. Peer Configuration
    // If hosting on your Node.js server, it uses the current window location
    const peer = new Peer({
        host: window.location.hostname,
        port: window.location.port || (window.location.protocol === 'https:' ? 443 : 80),
        path: '/peerjs/messenger', 
        secure: window.location.protocol === 'https:'
    });

    let activeConn = null;

    // 2. Peer Event Listeners
    peer.on('open', (id) => {
        document.getElementById('my-id').innerText = id;
        document.getElementById('dot').classList.add('online');
        log("System", "Ready for global connection.");
    });

    // Listen for incoming connection
    peer.on('connection', (conn) => {
        activeConn = conn;
        initConnection();
        log("System", "Inbound connection established.");
    });

    // 3. Functions
    function connectToPeer() {
        const id = document.getElementById('targetId').value;
        if (!id) return alert("Enter an ID first!");
        
        activeConn = peer.connect(id);
        initConnection();
    }

    function initConnection() {
        activeConn.on('open', () => {
            log("System", "Connected to peer successfully.");
        });
        
        activeConn.on('data', (data) => {
            log("Peer", data, "in");
        });

        activeConn.on('close', () => {
            log("System", "Connection lost.");
            activeConn = null;
        });
    }

    function sendMsg() {
        const input = document.getElementById('message');
        if (activeConn && activeConn.open) {
            activeConn.send(input.value);
            log("You", input.value, "out");
            input.value = "";
        } else {
            alert("No active connection. Click CONNECT first.");
        }
    }

    function log(user, text, type = "in") {
        const display = document.getElementById('display');
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerHTML = `<small style="display:block; font-size:0.7em; opacity:0.6">${user}</small>${text}`;
        display.appendChild(div);
        display.scrollTop = display.scrollHeight;
    }

    // Handle Enter key
    document.getElementById('message').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMsg();
    });
</script>

</body>
</html>
